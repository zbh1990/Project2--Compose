services:
  docker: # Docker-in-Docker service (DinD)
    image: docker:dind                   # Official DinD image
    container_name: dind
    privileged: true                     # Required for DinD to run Docker inside container
    environment:
      DOCKER_TLS_CERTDIR: /certs         # Enable TLS for secure Docker client-server comms
    networks:
      - jenkins                          # Connect DinD and Jenkins to same bridge network
    volumes:
      - docker-certs-ca:/certs/ca        # Stores CA certs generated by DinD
      - docker-certs-client:/certs/client # Stores client certs for Jenkins to connect securely
      - jenkins-data:/var/jenkins_home   # shared with Jenkins for persistence

  jenkins: # Jenkins CI/CD server
    image: jenkins/jenkins:lts-jdk11     # Stable LTS Jenkins with Java 11 runtime
    container_name: jenkins
    user: root                           # Run as root to install plugins/tools and access Docker
    restart: unless-stopped              # Auto-restart on crash/reboot
    depends_on:
      - docker                           # Wait until DinD is up before starting Jenkins
    networks:
      - jenkins
    environment:
      DOCKER_HOST: tcp://docker:2376     # Jenkins talks to DinD over TLS at port 2376
      DOCKER_CERT_PATH: /certs/client    # Path inside container where client certs are mounted
      DOCKER_TLS_VERIFY: 1               # Enforce TLS verification for Docker commands
      JENKINS_OPTS: "--prefix=/jenkins"  # Jenkins web UI served at /jenkins
    volumes:
      - docker-certs-client:/certs/client:ro # Mount certs read-only for security
      - jenkins-data:/var/jenkins_home        # Persist Jenkins jobs, config, plugins
    ports:
      - "8080:8080"   # Jenkins Web UI access
      - "50000:50000" # Agent-to-controller communication

# Shared network so Jenkins and DinD containers can talk to each other
networks:
  jenkins:
    driver: bridge

# Persistent volumes for Jenkins home and Docker TLS certs
volumes:
  jenkins-data:        # Jenkins home (jobs, config, plugins)
  docker-certs-ca:     # DinD-generated CA certs
  docker-certs-client: # DinD-generated client certs for Jenkins
